---
title: "You don't know JavaScript Yet:#10 é–‰åŒ…(Closures)"
date: "2020-03-16"
category: "FullStack"
cover: "/images/you-dont-know-js.png"
tags:
  - JavaScript
  - YDKJSY
---

åœ¨[ã€ŒYou don't know JavaScript Yet:#3 æ·±å…¥JSçš„æ ¸å¿ƒã€](/archives/2020-01-07-you-dont-know-js-yet-3)ä¸­æ›¾ç¶“æœ‰è«‡è«–éé—œæ–¼[é–‰åŒ…(Closures)](/archives/2020-01-07-you-dont-know-js-yet-3#é–‰åŒ…closure)ï¼Œåœ¨å‰é¢å¹¾å€‹ç« ç¯€ä¸­ä¹Ÿæ™‚ä¸æ™‚æœƒæåˆ°é–‰åŒ…ï¼Œä½†ä¸€ç›´æœªæ·±å…¥è¨è«–é€™å€‹è©±é¡Œï¼Œçµ‚æ–¼åˆ°äº†é€™ç« èƒ½å¥½å¥½åœ°æ¢ç©¶å®ƒäº†ã€‚é–‰åŒ…æ˜¯ç¨‹å¼èªè¨€é‡è¦çš„ç‰¹è‰²ä¹‹ä¸€ï¼Œå®ƒä¸åƒ…åªåœ¨JSä¸­å­˜åœ¨ï¼Œè‹¥è¦ç•¶ä¸€å€‹JSå¤§å¸«ï¼Œé‚£éº¼å–„ç”¨é–‰åŒ…æ˜¯å¿…é ˆç†Ÿç·´çš„æŠ€å·§ã€‚

## åˆæ¢é–‰åŒ…

ã€Œé–‰åŒ…æ˜¯å‡½å¼çš„ä¸€ç¨®ç‰¹æ€§ï¼Œå®ƒä¹Ÿåªæœƒç™¼ç”Ÿæ–¼å‡½å¼ä¸­ã€‚ã€

å¾ä¸Šé¢é€™å¥è©±å¯ä»¥çŸ¥é“ï¼Œè‹¥æˆ‘å€‘è¦è§€å¯Ÿé–‰åŒ…çš„è¡Œç‚ºï¼Œåªèƒ½é€éå»ºç«‹å‡½å¼ä¾†è§€å¯Ÿï¼Œæ‰€ä»¥åœ¨é€™è£¡æˆ‘å€‘æ²¿ç”¨å‰é¢ç« ç¯€ä¸­[ã€Œç¬¬ä¸€å€‹éš±å–»:å½ˆç èˆ‡æ³¡æ³¡ã€](/archives/2020-02-23-you-dont-know-js-yet-5#ç¬¬ä¸€å€‹éš±å–»å½ˆç èˆ‡æ³¡æ³¡)çš„ä¾‹å­:

```javascript
// outer/global scope: RED(1)

function lookupStudent(studentID) {
    // function scope: BLUE(2)

    var students = [
        { id: 14, name: "Kyle" },
        { id: 73, name: "Suzy" },
        { id: 112, name: "Frank" },
        { id: 6, name: "Sarah" }
    ];

    return function greetStudent(greeting){
        // function scope: GREEN(3)

        var student = students.find(
            student => student.id == studentID
        );

        return `${ greeting }, ${ student.name }!`;
    };
}

var chosenStudents = [
    lookupStudent(6),
    lookupStudent(112)
];

// accessing the function's name:
chosenStudents[0].name;
// greetStudent

chosenStudents[0]("Hello");
// Hello, Sarah!

chosenStudents[1]("Howdy");
// Howdy, Frank!
```

é¦–å…ˆ`lookupStudent(..)`æœƒå›å‚³å‡½å¼`greetStudent(..)`ï¼Œé€™è£¡åŸ·è¡Œäº†å…©æ¬¡`lookupStudent(..)`ä¸¦å°‡çµæœå„²å­˜æ–¼é™£åˆ—`chosenStudents`ç•¶ä¸­ï¼Œæˆ‘å€‘é€é`.name`é€™å€‹å±¬æ€§ä¾†ç¢ºèªå‡½å¼æ˜¯å¦ç¬¦åˆæˆ‘å€‘çš„é æœŸï¼Œå®ƒä¹Ÿç¢ºå¯¦æ˜¯`greetStudent(..)`çš„å¯¦ä¾‹ã€‚

æ¥è‘—åœ¨æ¯æ¬¡`lookupStudent(..)`åŸ·è¡Œå®Œç•¢å¾Œï¼Œé€šå¸¸å…§éƒ¨è®Šæ•¸éƒ½æœƒé€éGC(garbage collected)è‡ªå‹•é‡‹æ”¾è¨˜æ†¶é«”ï¼Œåªä¿ç•™å›å‚³å€¼`greetStudent(..)`ï¼Œé€™é‚Šå°±æ˜¯æˆ‘å€‘æƒ³è¦è§€å¯Ÿçš„åœ°æ–¹ã€‚`greetStudent(..)`å…è¨±è¼¸å…¥ä¸€å€‹åƒæ•¸`greeting`ï¼ŒåŒæ™‚åœ¨å®ƒè£¡é¢ä½¿ç”¨äº†ä¾†è‡³æ–¼`lookupStudent`ç¯„ç–‡ä¸­çš„`students`èˆ‡`studentID`ï¼Œä¸¦å°‡å®ƒå€‘å°å­˜æ–¼å…§éƒ¨å‡½å¼ä¹‹ä¸­ï¼Œé€™ç¨®åƒè€ƒå¤–éƒ¨ç¯„ç–‡è®Šæ•¸ä¸¦å°‡å…¶å°å­˜çš„è¡Œç‚ºç¨±ç‚º**é–‰åŒ…(closure)**ï¼Œè‹¥å­¸è¡“ä¸€é»çš„èªªæ³•:*`greetStudent(..)` closes over the outer variables `students` and `studentID`*ï¼Œé€™å¥è©±å‚³é”å¹¾å€‹æ„æ€:

1. `greetStudent(..)`ç‚ºé–‰åŒ…ï¼Œæ„å‘³è‘—å®ƒæ˜¯å‡½å¼ã€‚
2. é–‰åŒ…å°‡ä¸€äº›è®Šæ•¸`students`èˆ‡`studentID`å°å­˜(closes over, è‹¥æœ‰æ›´å¥½çš„ç¿»è­¯æ­¡è¿æä¾›)æ–¼å®ƒçš„ç¯„ç–‡ç•¶ä¸­ã€‚

åœ¨ç¬¬ä¸‰ç« ä¸­æ›¾ç¶“æœ‰çµ¦é–‰åŒ…ä¸€å€‹ç°¡å–®çš„å®šç¾©:ã€Œé–‰åŒ…æ˜¯è®“å‡½å¼è¨˜ä½èˆ‡æŒçºŒè¨ªå•åœ¨å…¶ç¯„ç–‡ä¹‹å¤–çš„è®Šæ•¸çš„ä¸€ç¨®èƒ½åŠ›ï¼Œå³ä½¿è©²å‡½å¼åœ¨å…¶ä»–ç¯„ç–‡ä¸­åŸ·è¡Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚ã€ï¼Œç”¨é€™å€‹å®šç¾©ä¾†çœ‹é€™å€‹ä¾‹å­ï¼Œé–‰åŒ…ä½¿å¾—`greetStudent(..)`èƒ½æŒçºŒè¨ªå•å®ƒç¯„ç–‡ä¹‹å¤–çš„è®Šæ•¸(`students`èˆ‡`studentID`)å³ä½¿`lookupStudent(..)`å·²ç¶“åŸ·è¡Œå®Œç•¢ï¼Œ`students`èˆ‡`studentID`ä¹Ÿä¸æœƒè¢«GCçµ¦æ¸…æ‰è€Œæ˜¯ä¿ç•™å®ƒå€‘çš„è¨˜æ†¶é«”ã€‚åœ¨é€™ä¹‹å¾Œ`greetStudent`åœ¨å…¨åŸŸç¯„ç–‡ä¸­åŸ·è¡Œæ™‚ï¼Œé€™äº›è®Šæ•¸ä¾ç„¶è¢«ä¿ç•™è‘—ã€‚

å¦‚æœJSæ²’æœ‰é–‰åŒ…çš„èƒ½åŠ›ï¼Œç•¶`lookupStudent(..)`å›å‚³`greetStudent(..)`ä¹‹å¾Œï¼Œä»£è¡¨`students`èˆ‡`studentID`éƒ½å°‡è¢«GCçµ¦å›æ”¶ï¼Œè‹¥æ­¤æ™‚åœ¨åŸ·è¡Œä»»æ„ä¸€å€‹`greetStudent(..)`ï¼Œå®ƒæœƒå˜—è©¦å»å°‹æ‰¾å‡½å¼ç¯„ç–‡BLUE(2)ä¸­çš„è®Šæ•¸ï¼Œä½†BLUE(2)å·²ç¶“ä¸å­˜åœ¨äº†ï¼Œæ‰€ä»¥æœƒæ‹‹å‡º`ReferenceError`ã€‚ä½†å¯¦éš›ä¸ŠåŸ·è¡Œ`chosenStudents[0]("Hello")`æ˜¯æœ‰è·‘å‡º`Hello, Sarah`çš„ï¼Œæ‰€ä»¥ä»£è¡¨`students`èˆ‡`studentID`éƒ½é‚„å­˜åœ¨æ–¼è¨˜æ†¶é«”ç•¶ä¸­ï¼Œé€™å°±æ˜¯é–‰åŒ…çš„èƒ½åŠ›ã€‚

åœ¨ä¸Šé¢çš„ä¾‹å­ç•¶ä¸­æˆ‘å€‘é‚„éºæ¼äº†ä¸€é»å°ç´°ç¯€ï¼Œä¸Šé¢çš„[ç®­é ­å‡½å¼(arrow functions)](/archives/2020-02-27-you-dont-know-js-yet-6#ç®­é ­å‡½å¼arrow-functions)ä¹Ÿæ˜¯ä¸€å€‹ç¯„ç–‡ï¼Œé€™æ˜¯æˆ‘å€‘å¸¸ç–å¿½çš„åœ°æ–¹:

```javascript
var student = students.find(
    student =>
        // function scope: ORANGE(4)
        student.id == studentID
);
```

ORANGE(4)ä¸­åƒè€ƒäº†BLUE(2)çš„`studentID`ï¼Œé€™å€‹ç®­é ­å‡½å¼æ˜¯åŸºæ–¼æŒæœ‰`studentID`çš„é–‰åŒ…ï¼Œæ‰€ä»¥å¯¦éš›ä¸Š`greetStudent(..)`æ²’æœ‰æŒæœ‰`studentID`ï¼Œä¸éé€™ä¸å½±éŸ¿é‹ä½œï¼Œä½†äº†è§£äº‹å¯¦æœ‰åŠ©æ–¼ç†è§£é–‰åŒ…ï¼Œå³ä½¿æ˜¯å°å°çš„ç®­é ­å‡½å¼ä¹Ÿèƒ½æ“æœ‰é–‰åŒ…ã€‚

è®“æˆ‘å€‘çœ‹çœ‹ä¸€å€‹ç¶“å¸¸è¢«å¼•ç”¨ä½œç‚ºé–‰åŒ…çš„ä¾‹å­:

```javascript
function adder(num1) {
    return function addTo(num2){
        return num1 + num2;
    };
}

var add10To = adder(10);
var add42To = adder(42);

add10To(15);    // 25
add42To(9);     // 51
```

æ¯ä¸€æ¬¡å¯¦ä¾‹åŒ–`adder(..)`éƒ½å°‡è®Šæ•¸`num1`å°å­˜æ–¼`addTo(..)`ä¸­ï¼Œç•¶`adder(..)`åŸ·è¡Œå®Œç•¢ä¹Ÿä¸æœƒé‡‹æ”¾`num1`çš„è¨˜æ†¶é«”ï¼Œæ‰€ä»¥ç•¶ä¸Šé¢åŸ·è¡Œ`add10To(15)`æ™‚ï¼Œå°±ç­‰åŒæ–¼`10 + 15`ï¼Œæ¯æ¬¡åŸ·è¡Œ`add10To(..)`éƒ½æœƒæ˜¯`10 + num2`ã€‚

åœ¨é€™è£¡è¦èªªä¸€å€‹å¾ˆå®¹æ˜“è¢«å¿½ç•¥çš„é‡è¦ç´°ç¯€ï¼Œå‰é¢ç« ç¯€å†ä»‹ç´¹[ã€Œèªå½™ç¯„ç–‡ã€](/archives/2020-02-23-you-dont-know-js-yet-5)æ™‚ï¼Œæˆ‘å€‘çŸ¥é“ç¯„ç–‡æ±ºå®šæ–¼ç·¨è­¯æœŸï¼Œä½†åœ¨ä¸Šé¢çš„ä¾‹å­ï¼Œæ¯æ¬¡é€²è¡Œå¯¦ä¾‹åŒ–`adder(..)`éƒ½æœƒå‰µå»ºä¸€å€‹æ–°çš„å‡½å¼`addTo(..)`ï¼Œä¸¦ä¸”ç‚ºå®ƒå€‘å»ºç«‹æ–°çš„é–‰åŒ…ï¼Œå„˜ç®¡é–‰åŒ…æ˜¯åŸºæ–¼èªå½™ç¯„ç–‡ï¼Œä½†é–‰åŒ…çš„ç‰¹å¾µè¡¨ç¾æ–¼å‡½å¼å¯¦ä¾‹åŒ–çš„æ™‚å€™ã€‚

### å³æ™‚éˆçµï¼Œè€Œéå¿«ç…§

åœ¨å‰é¢çš„å…©å€‹ä¾‹å­ä¸­ï¼Œæˆ‘å€‘é€éé–‰åŒ…ä¿å­˜çš„è®Šæ•¸ä¾†è®€å–å€¼ï¼Œæ„Ÿè¦ºå¾ˆåƒæ˜¯ç•¶æˆ‘å€‘è¦è®€å–å€¼æ™‚ï¼Œé–‰åŒ…åœ¨æŸå€‹æ™‚é–“é»å°‡å€¼çš„å¿«ç…§(é–‰åŒ…ç•¶æ™‚çš„å€¼)å‚³çµ¦æˆ‘å€‘ï¼Œé€™æ˜¯å¾ˆå¤šäººå®¹æ˜“èª¤è§£çš„åœ°æ–¹ã€‚

é–‰åŒ…å¯¦éš›ä¸Šç‚ºå³æ™‚éˆçµï¼Œä½ ä¸åªå¯ä»¥å°è®Šæ•¸é€²è¡Œè®€å–çš„å‹•ä½œï¼Œä¹Ÿèƒ½å¤ é€²è¡Œè³¦å€¼çš„å‹•ä½œï¼Œé€™ä»£è¡¨é–‰åŒ…æ‰€å°å­˜çš„æ˜¯ä¸€å€‹å®Œæ•´çš„è®Šæ•¸ï¼Œé€™ä¹Ÿæ˜¯é–‰åŒ…ç‚ºä»€éº¼å¦‚æ­¤å¼·å¤§ä¸¦ä¸”ç”¨åœ¨è¨±å¤šç¨‹å¼èªè¨€ä¸Šçš„åŸå› ã€‚

è®“æˆ‘å€‘ä¾†çœ‹çœ‹ä¾‹å­:

```javascript
function makeCounter() {
    var count = 0;

    return getCurrent(){
        count = count + 1;
        return count;
    };
}

var hits = makeCounter();

hits();     // 1
hits();     // 2
hits();     // 3
```

è®Šæ•¸`count`è¢«å°å­˜æ–¼å…§éƒ¨å‡½å¼`getCurrent()`ä¸­ï¼Œ`hits()`æ¯æ¬¡åŸ·è¡Œéƒ½æœƒä½¿`count`éå¢ã€‚å„˜ç®¡é–‰åŒ…æ‰€å°å­˜çš„è®Šæ•¸é€šå¸¸ä¾†è‡³æ–¼å‡½å¼ä¸­ï¼Œä½†é€™ä¸¦éå¿…è¦çš„ï¼Œåªè¦ä»»æ„ç¯„ç–‡ä¸­æœ‰ä¸€å€‹å‡½å¼ï¼Œä¸”é€™å‡½å¼ä½¿ç”¨å¤–éƒ¨ç¯„ç–‡çš„è®Šæ•¸å³å¯:

```javascript
var hits;
{   // an outer scope (but not a function)
    let count = 0;
    hits = function getCurrent(){
        count = count + 1;
        return count;
    };
}
hits();     // 1
hits();     // 2
hits();     // 3
```

[[info]]
|é€™è£¡ä½¿ç”¨å‡½å¼è¡¨é”å¼çš„åŸå› æ–¼å‰ä¸€ç« æœ‰æåˆ°ï¼Œé¿å…[FiB](/archives/2020-03-12-you-dont-know-js-yet-9#function-declarations-in-blocks-fib)æ‰€å¸¶ä¾†çš„å±å®³ã€‚

é‚„æœ‰ä¸€ç¨®éŒ¯èª¤çš„ç‹€æ³ä¹Ÿå¾ˆå¸¸è¦‹:

```javascript
var keeps = [];

for (var i = 0; i < 3; i++) {
    keeps[i] = function keepI(){
        // closure over `i`
        return i;
    };
}

keeps[0]();   // 3 -- WHY!?
keeps[1]();   // 3
keeps[2]();   // 3
```

ä½ å¯èƒ½æœŸå¾…`keeps[0]()`æœƒå›å‚³`0`ï¼Œä½†ç”±æ–¼è®Šæ•¸`i`æ˜¯é€é`var`é€²è¡Œå®£å‘Šçš„ï¼Œåœ¨ç¬¬å…«ç« çš„[ã€Œå¯ä»¥ä½¿ç”¨è®Šæ•¸çš„æ™‚é–“é»ã€](/archives/2020-03-06-you-dont-know-js-yet-8#å¯ä»¥ä½¿ç”¨è®Šæ•¸çš„æ™‚é–“é»)ä¸­æœ‰æéï¼Œè‹¥ä½¿ç”¨`var`å®£å‘Šçš„è®Šæ•¸æœƒèˆ‡æœ€è¿‘çš„å‡½å¼ç¯„ç–‡é€£çµ(è‹¥æ²’æœ‰å‡½å¼ç¯„ç–‡å‰‡èˆ‡å…¨åŸŸç¯„ç–‡é€£çµ)ï¼Œæ‰€ä»¥é€™è£¡ä½ å¯ä»¥çœ‹æˆå¦‚ä¸‹:

```javascript
var keeps = [];
var i;
for (i = 0; i < 3; i++) {
    keeps[i] = function keepI(){
        // closure over `i`
        return i;
    };
}

keeps[0]();   // 3 -- WHY!?
keeps[1]();   // 3
keeps[2]();   // 3
```

ç•¶`for`è¿´åœˆåŸ·è¡ŒçµæŸå¾Œï¼Œæœ€å¾Œ`i`çš„å€¼ç‚º`3`ï¼Œå‰é¢æåˆ°é–‰åŒ…ä¸¦éä½¿ç”¨å¿«ç…§ï¼Œè€Œæ˜¯å³æ™‚éˆçµï¼Œé€™é‚Šå°±æ˜¯ä¸€å€‹å¥½çš„è­‰æ˜ã€‚æ‰€ä»¥è¦è§£æ±ºé€™å•é¡Œçš„æœ€å¿«æ–¹æ³•å°±æ˜¯æŠŠ`var`æ”¹æˆ`let`å³å¯:

```javascript
var keeps = [];

for (let i = 0; i < 3; i++) {
    // the `let i` gives us a new `i` for
    // each iteration, automatically!
    keeps[i] = function keepEachI(){
        return i;
    };
}
keeps[0]();   // 0
keeps[1]();   // 1
keeps[2]();   // 2
```

é€™æ¨£åœ¨è¿´åœˆä¸­æ¯æ¬¡éƒ½æœƒå»ºç«‹ä¸€å€‹ç¨ç«‹çš„`i`å‡ºä¾†ï¼Œå°±ä¸æœƒæœ‰ä¸Šé¢çš„å•é¡Œã€‚

### å¦‚æœæ²’è¾¦æ³•è§€å¯Ÿåˆ°é–‰åŒ…å‘¢

å¦‚æœä¸€å€‹é–‰åŒ…å®ƒå­˜åœ¨æ–¼ç¨‹å¼çš„æŸè™•ï¼Œä½†æˆ‘å€‘ç„¡æ³•å¯Ÿè¦ºåˆ°å®ƒçš„å­˜åœ¨ï¼Œé€™é‡è¦å—?å¯¦éš›ä¸Šä¸é‡è¦ã€‚é‡è¦çš„æ˜¯æˆ‘å€‘èƒ½é€éè§€å¯Ÿä¾†å¯Ÿè¦ºé–‰åŒ…çš„å­˜åœ¨ã€‚

æˆ‘å€‘ç”¨å¹¾å€‹ä¾‹å­ä¾†å¼·èª¿é€™é»:

```javascript
function say(myName) {
    var greeting = "Hello";
    output();

    function output() {
        console.log(
            `${ greeting }, ${ myName }!`
        );
    }
}

say("Kyle");
// Hello, Kyle!
```

å…§éƒ¨å‡½å¼`output()`ä½¿ç”¨äº†`greeting`èˆ‡`myName`ï¼Œä½†èª¿ç”¨`output()`ä¹Ÿåœ¨åŒä¸€å€‹ç¯„ç–‡ç•¶ä¸­ï¼Œæ‰€ä»¥é€™åªæ˜¯å–®ç´”çš„èªå½™ç¯„ç–‡ä¸”ä¸¦æ²’æœ‰é–‰åŒ…å­˜åœ¨ï¼Œä½†å®ƒçœ‹èµ·ä¾†åƒæ˜¯æœ‰é–‰åŒ…å­˜åœ¨ä¸€æ¨£ã€‚

å†çœ‹çœ‹å¦å¤–ä¸€å€‹ä¾‹å­:

```javascript
var students = [
    { id: 14, name: "Kyle" },
    { id: 73, name: "Suzy" },
    { id: 112, name: "Frank" },
    { id: 6, name: "Sarah" }
];

function getFirstStudent() {
    return function firstStudent(){
        return students[0].name;
    };
}

var student = getFirstStudent();

student();
// Kyle
```

å¯¦éš›ä¸Šå…¨åŸŸè®Šæ•¸æ²’è¾¦æ³•é€éè§€å¯Ÿä¾†ç¢ºèªå®ƒæ˜¯å¦ç”¨æ–¼é–‰åŒ…ï¼Œå› ç‚ºå®ƒåœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½å¤ è¢«ä½¿ç”¨ã€‚`students`é›–ç„¶è¢«ç”¨æ–¼å…§éƒ¨å‡½å¼`firstStudent()`ç•¶ä¸­ï¼Œä½†ç”±æ–¼`students`ä½è™•æ–¼å…¨åŸŸç¯„ç–‡ç•¶ä¸­ï¼Œé€éé€™æ¨£èª¿ç”¨è·Ÿä½¿ç”¨æ­£å¸¸çš„èªå½™ç¯„ç–‡æ²’ä»€éº¼å€åˆ¥ã€‚æ‰€æœ‰å‡½å¼éƒ½èƒ½ä½¿ç”¨å…¨åŸŸè®Šæ•¸ï¼Œç„¡è«–è©²ç¨‹å¼èªè¨€æ˜¯å¦æ”¯æ´é–‰åŒ…ï¼Œåœ¨æ­¤è™•ä½¿ç”¨é–‰åŒ…æœ‰é»å¤šæ­¤ä¸€èˆ‰çš„æ„Ÿè¦ºã€‚

ä¸‹ä¸€å€‹ä¾‹å­ä¸­ï¼Œè®Šæ•¸è‹¥æ²’æœ‰è¢«ä½¿ç”¨åˆ°ï¼Œå°±ä¸æœƒæœ‰é–‰åŒ…çš„å­˜åœ¨:

```javascript
function lookupStudent(studentID) {
    return function nobody(){
        var msg = "Nobody's here yet.";
        console.log(msg);
    };
}

var student = lookupStudent(112);

student();
// Nobody's here yet.
```

å…§éƒ¨å‡½å¼`nobody()`ä¸­æœªæ›¾ä½¿ç”¨åˆ°`studentID`ä¹Ÿæœªå°å­˜ä»»ä½•è®Šæ•¸ï¼Œå®ƒåªç”¨åˆ°è‡ªå·±ç¯„ç–‡å…§çš„`msg`ï¼Œç•¶åŸ·è¡Œ`lookupStudent(..)`æ™‚ï¼Œ`studentID`å› ç‚ºæ²’æœ‰è¢«`nobody()`ä½¿ç”¨åˆ°ï¼Œæ‰€ä»¥æœ€å¾ŒGCæœƒå°å…¶é€²è¡Œè¨˜æ†¶é«”æ¸…é™¤çš„å‹•ä½œã€‚

æœ€å¾Œä¸€å€‹ä¾‹å­ï¼Œè‹¥å‡½å¼æœªè¢«èª¿ç”¨ï¼Œå„˜ç®¡å®ƒæœ‰é–‰åŒ…çš„è¡Œç‚ºå­˜åœ¨ï¼Œä½†å®ƒä¾ç„¶ä¸ç®—æ˜¯ä¸€å€‹é–‰åŒ…:

```javascript
function greetStudent(studentName) {
    return function greeting(){
        console.log(
            `Hello, ${ studentName }!`
        );
    };
}

greetStudent("Kyle");

// nothing else happens
```

ç”±æ–¼é€™é‚Šèª¿ç”¨`greetStudent(..)`ä½†æœªä½¿ç”¨ä¸€å€‹è®Šæ•¸æ¥æ”¶å®ƒçš„å›å‚³å€¼ï¼Œæ‰€ä»¥ç•¶åŸ·è¡Œå®Œç•¢å›å‚³å€¼ä¹Ÿç›´æ¥è¢«å›æ”¶æ‰äº†ï¼ŒæŠ€è¡“ä¸Šä¾†èªªJSåœ¨çŸ­æš«æ™‚é–“å…§æœ‰é–‰åŒ…çš„å­˜åœ¨ï¼Œä½†å› ç‚ºæˆ‘å€‘ç„¡æ³•è§€å¯Ÿåˆ°ï¼Œæ‰€ä»¥ä¹Ÿæ²’ä»€éº¼æ„ç¾©ã€‚

### å¯è§€å¯Ÿçš„å®šç¾©

ã€Œç•¶ä¸€å€‹å‡½å¼ä½¿ç”¨å¤–éƒ¨ç¯„ç–‡çš„è®Šæ•¸æ™‚ï¼Œå³ä½¿åœ¨ç„¡æ³•å­˜å–é€™äº›è®Šæ•¸çš„ç¯„ç–‡ä¸­åŸ·è¡Œé€™å€‹å‡½å¼ï¼Œä¹Ÿèƒ½è§€å¯Ÿåˆ°é–‰åŒ…(Closure is observed when a function uses variable(s) from outer scope(s) even while running in a scope where those variable(s) wouldn't be accessible.)ã€‚ã€

ä¸Šé¢é€™æ®µ(ç¿»çš„ä¸å¥½è«‹è¦‹è«’ğŸ˜“)æœ‰å¹¾å€‹æ„ç¾©å­˜åœ¨:

- å¿…é ˆæœ‰ä¸€å€‹å‡½å¼è¢«èª¿ç”¨ã€‚
- é€™å€‹å‡½å¼è‡³å°‘ä½¿ç”¨ä¸€å€‹å¤–éƒ¨ç¯„ç–‡çš„è®Šæ•¸ã€‚
- å¿…é ˆåœ¨èˆ‡é€™å€‹(äº›)è®Šæ•¸ä¸åŒçš„ç¯„ç–‡ä¸­ï¼Œä½¿ç”¨é€™å€‹å‡½å¼ã€‚

é€™æ„å‘³è‘—æˆ‘å€‘æ‡‰è©²ä»¥æ˜¯å¦èƒ½å¤ è§€å¯Ÿåˆ°é–‰åŒ…æœƒå°ç¨‹å¼é€ æˆå½±éŸ¿æˆ–è€…ç”¢ç”Ÿä»€éº¼è¡Œç‚ºä¾†å®šç¾©é–‰åŒ…ï¼Œè€Œä¸æ˜¯å°‡é–‰åŒ…é€éæŸç¨®å­¸è¡“å®šç¾©ä¾†èªªæ˜å®ƒã€‚

## é–‰åŒ…çš„ç”Ÿå‘½é€±æœŸèˆ‡åƒåœ¾å›æ”¶(Garbage Collection, GC)

ç”±æ–¼é–‰åŒ…æœ¬è³ªä¸Šèˆ‡å‡½å¼çš„å¯¦ä¾‹é—œè¯è‘—ï¼Œåªè¦é€™å€‹å‡½å¼referenceä¸€ç›´è¢«ä½¿ç”¨è‘—ï¼Œé–‰åŒ…ä¸­çš„è®Šæ•¸ä¹ŸæœƒæŒçºŒå­˜åœ¨è‘—ã€‚

å‡è¨­ä½ æœ‰åå€‹å‡½æ•¸å…¨éƒ¨éƒ½å°å­˜æŸå€‹è®Šæ•¸ï¼Œä½†éš¨è‘—æ™‚é–“æµé€ï¼Œå…¶ä¸­ä¹å€‹å‡½å¼referenceå·²ç¶“è¢«ä¸Ÿæ£„äº†ï¼Œä½†åªè¦é‚„æœ‰ä¸€å€‹å‡½å¼çš„referenceé‚„å­˜åœ¨ï¼Œä»ç„¶æœƒä¿ç•™è©²è®Šæ•¸ï¼Œç›´åˆ°æœ€å¾Œä¸€å€‹å‡½å¼referenceè¢«ä¸Ÿæ£„ï¼Œé€™å€‹è®Šæ•¸å°±æœƒè¢«GCè™•ç†æ‰ã€‚

é€™å°æ–¼ç¨‹å¼çš„æ•ˆèƒ½ä¾†èªªå¾ˆé‡è¦ï¼Œå› ç‚ºé€™ä»£è¡¨è‘—å¦‚æœæœ‰ä¸€å †å‡½å¼å°å­˜äº†ä¸€å †è®Šæ•¸ï¼Œé€™äº›è®Šæ•¸éƒ½å­˜åœ¨æ–¼è¨˜æ†¶é«”ç•¶ä¸­ï¼Œå®ƒå€‘å¯èƒ½æ„å¤–åœ°é˜»æ­¢äº†GCåšæ¸…é™¤çš„å‹•ä½œï¼Œé€²è€Œå°è‡´è¨˜æ†¶é«”çš„éåº¦ä½¿ç”¨ï¼Œæ‰€ä»¥ç•¶å‡½å¼referenceä¸å†è¢«éœ€è¦ä½¿ç”¨æ™‚å°±é€²è¡Œä¸Ÿæ£„çš„å‹•ä½œæ˜¯å¾ˆé‡è¦çš„ã€‚

è€ƒæ…®ä¸€ä¸‹ç¨‹å¼ç¢¼:

```javascript
function manageBtnClickEvents(btn) {
    var clickHandlers = [];

    return function listener(cb){
        if (cb) {
            let clickHandler =
                function onClick(evt){
                    console.log("clicked!");
                    cb(evt);
                };
            clickHandlers.push(clickHandler);
            btn.addEventListener(
                "click",
                clickHandler
            );
        }
        else {
            // passing no callback unsubscribes
            // all click handlers
            for (let handler of clickHandlers) {
                btn.removeEventListener(
                    "click",
                    handler
                );
            }

            clickHandlers = [];
        }
    };
}

// var mySubmitBtn = ..
var onSubmit = manageBtnClickEvents(mySubmitBtn);

onSubmit(function checkout(evt){
    // handle checkout
});

onSubmit(function trackAction(evt){
    // log action to analytics
});

// later, unsubscribe all handlers:
onSubmit();
```

æˆ‘å€‘å»ºç«‹å‡½å¼`checkout(..)`èˆ‡å‡½å¼`trackAction(..)`å‚³çµ¦å‡½å¼`listener(..)`çš„åƒæ•¸`cb`é€²è¡Œç›£è½é»æ“Šäº‹ä»¶ä¸¦ä¸”å‡½å¼`onClick`æœƒå°`cb`é€²è¡Œå°å­˜ã€‚åœ¨æœ€å¾Œä¸€è¡Œæˆ‘å€‘ä¸å¸¶ä»»ä½•åƒæ•¸ç”¨ä¾†åŸ·è¡Œæ¸…é™¤çš„å‹•ä½œï¼Œé€™å°‡æœƒå–æ¶ˆæ‰€æœ‰æ›¾ç¶“ç›£è½éçš„é»æ“Šäº‹ä»¶ä¸¦ä¸”æŠŠ`clickHandlers`æ¸…æˆç©ºé™£åˆ—ï¼Œé€™ä»£è¡¨ç¶“ç”±`cb`ä½¿ç”¨`checkout(..)`èˆ‡`trackAction(..)`çš„å‡½å¼referenceéƒ½ä¸€ä½µè¢«æ¸…é™¤äº†ï¼Œæ‰€ä»¥GCå°±æœƒé‡‹æ”¾å®ƒå€‘çš„è¨˜æ†¶é«”ã€‚

è€ƒæ…®ç¨‹å¼æ•´é«”é‹è¡Œç‹€æ³ä»¥åŠæ•ˆèƒ½ï¼Œå°‡ä¸å†éœ€è¦ä½¿ç”¨çš„äº‹ä»¶å–æ¶ˆç›£è½æ¯”é€²è¡Œç›£è½æ›´ç‚ºé‡è¦ã€‚

### å°å­˜éƒ¨åˆ†è®Šæ•¸é‚„æ˜¯æ•´å€‹ç¯„ç–‡

æˆ‘å€‘æ‡‰è©²åªå°å­˜æˆ‘å€‘æœ‰åƒè€ƒåˆ°çš„è®Šæ•¸ï¼Œé‚„æ˜¯å°‡æ•´å€‹ç¯„ç–‡éˆçš„è®Šæ•¸éƒ½é€²è¡Œå°å­˜å‘¢?

æ¦‚å¿µä¸Šä¾†èªªï¼Œåªå°å­˜æœ‰åƒè€ƒåˆ°çš„è®Šæ•¸å°±å¥½ï¼Œä½†å¯¦éš›æƒ…æ³æ²’æœ‰æˆ‘å€‘æƒ³çš„é‚£éº¼ç°¡å–®ï¼Œè€ƒæ…®ä»¥ä¸‹ç¨‹å¼ç¢¼:

```javascript
function manageStudentGrades(studentRecords) {
    var grades = studentRecords.map(getGrade);

    return addGrade;

    // ************************

    function getGrade(record){
        return record.grade;
    }

    function sortAndTrimGradesList() {
        // sort by grades, descending
        grades.sort(function desc(g1,g2){
            return g2 - g1;
        });

        // only keep the top 10 grades
        grades = grades.slice(0,10);
    }

    function addGrade(newGrade) {
        grades.push(newGrade);
        sortAndTrimGradesList();
        return grades;
    }
}

var addNextGrade = manageStudentGrades([
    { id: 14, name: "Kyle", grade: 86 },
    { id: 73, name: "Suzy", grade: 87 },
    { id: 112, name: "Frank", grade: 75 },
    // ..many more records..
    { id: 6, name: "Sarah", grade: 91 }
]);

// later

addNextGrade(81);
addNextGrade(68);
// [ .., .., ... ]
```

å‡½å¼`manageStudentGrades(..)`æ¥æ”¶ä¸€çµ„å­¸ç”Ÿæˆç¸¾çš„é™£åˆ—ä¸¦ä¸”å›å‚³å‡½å¼`addGrade(..)`çš„referenceçµ¦`addNextGrade`ï¼Œæ¯ç•¶å‘¼å«`addNextGrade(..)`å°±æœƒæ–°å¢ä¸€å€‹æˆç¸¾ï¼Œæ¥è‘—å°‡æˆç¸¾æ’åºå¾Œå–å‰ååï¼Œ`grades`é€éé–‰åŒ…ä¿å­˜æ–¼`addGrade(..)`ä¹‹ä¸­ï¼Œé€™æ˜¯å…¶ä¸­ä¸€å€‹è¢«`addGrade(..)`å°å­˜çš„è®Šæ•¸ï¼Œé‚„æœ‰å¦å¤–ä¸€å€‹è¢«å°å­˜çš„å°è±¡æ˜¯å‡½å¼`sortAndTrimGradesList()`ï¼Œå‡½å¼ä¹Ÿæ˜¯é–‰åŒ…å°å­˜çš„å°è±¡ä¹‹ä¸€ã€‚

æƒ³æƒ³çœ‹é‚„æœ‰å“ªäº›æ˜¯è¢«å°å­˜çš„è®Šæ•¸?

å‡½å¼`getGrade(..)`æœ‰è¢«å°å­˜å—?å®ƒåªè¢«ç”¨æ–¼`manageStudentGrades(..)`ç¯„ç–‡çš„ä¸€é–‹å§‹ï¼Œä½†æ²’è¢«ç”¨æ–¼`addGrade(..)`èˆ‡`sortAndTrimGradesList()`ä¸­ï¼Œæ‰€ä»¥å®ƒæ²’æœ‰è¢«å°å­˜ã€‚

å†çœ‹çœ‹`studentRecords`ï¼Œå®ƒèˆ‡`getGrade(..)`ä¸€æ¨£åªè¢«ç”¨æ–¼ç¯„ç–‡çš„ä¸€é–‹å§‹ï¼Œè‹¥`studentRecords`æœ‰è¢«å°å­˜çš„è©±ï¼Œé‚£éº¼å°è¨˜æ†¶é«”ä¾†èªªçµ•å°æ˜¯ä¸€å¤§è² æ“”ï¼Œä½†æˆ‘å€‘é€éè§€å¯Ÿï¼Œå¯¦éš›ä¸Šå®ƒä¸¦æ²’æœ‰è¢«å°å­˜ã€‚

æ ¹æ“šæˆ‘å€‘å‰é¢ç†è§£é–‰åŒ…çš„å®šç¾©ï¼Œç•¶`manageStudentGrades(..)`åŸ·è¡Œå®Œç•¢æ™‚ï¼Œæœªè¢«å°å­˜çš„è®Šæ•¸éƒ½æœƒè¢«GCçµ¦æ¸…é™¤æ‰ã€‚æˆ‘å€‘å¯ä»¥å˜—è©¦ä½¿ç”¨åœ¨chromeä¸Šçš„DevToolsä¸­é€²è¡ŒDebugï¼Œè¨­ç«‹ä¸€å€‹ä¸­æ–·é»åœ¨`addGrade(..)`ä¸­ï¼Œæ¥è‘—å¯ä»¥æ³¨æ„åˆ°è®Šæ•¸`studentRecords`æœªè¢«åˆ—å‡ºå®ƒçš„å€¼ï¼Œé€™èƒ½å¤ è­‰æ˜å®ƒä¸¦æ²’æœ‰è¢«å°å­˜ã€‚

ä½†æ˜¯ä¸Šè¿°é€™ç¨®é©—è­‰æ–¹å¼å¯é å—?çœ‹çœ‹ä¸‹é¢ä¾‹å­:

```javascript
function storeStudentInfo(id,name,grade) {
    return function getInfo(whichValue){
        // warning:
        //   using `eval(..)` is a bad idea!
        var val = eval(whichValue);
        return val;
    };
}

var info = storeStudentInfo(73,"Suzy",87);

info("name");
// Suzy

info("grade");
// 87
```

æ³¨æ„åˆ°å…§éƒ¨å‡½å¼`getInfo`ä¸¦æ²’æœ‰å°å­˜`id`ã€`name`æˆ–è€…`grade`ï¼Œä½†æ˜¯æˆ‘å€‘é€éåŸ·è¡Œ`info(..)`ä»ç„¶å¯ä»¥ç²å¾—é€™äº›å€¼ï¼Œé€™é•èƒŒæˆ‘å€‘ä¸Šé¢è«‡è«–åˆ°çš„ã€‚

é€™é‚Šçš„çµæœèˆ‡å‰é¢æˆ‘å€‘æ‰€æè¿°çš„åˆä¸ä¸€æ¨£äº†ï¼Œè®Šæ•¸ä¸è«–æ˜¯å¦æœ‰è¢«å…§éƒ¨å‡½å¼åƒè€ƒéƒ½æœƒè¢«é–‰åŒ…ä¿ç•™è‘—ã€‚é‚£éº¼å›åˆ°æˆ‘å€‘ä¸€é–‹å§‹çš„è­°é¡Œï¼Œé€™æ¨£æ˜¯å¦å‚¾å‘æ–¼æ•´å€‹ç¯„ç–‡éˆçš„è®Šæ•¸éƒ½æœƒè¢«å°å­˜å‘¢?è¦–æƒ…æ³è€Œå®šã€‚

è¨±å¤šç¾ä»£åŒ–çš„JS engineéƒ½æœƒåšæœ€ä½³åŒ–çš„å‹•ä½œï¼Œå°‡é‚£äº›æœªæ˜ç¢ºä½¿ç”¨çš„è®Šæ•¸å¾é–‰åŒ…ä¸­ç§»é™¤ã€‚ä½†æ­£å¦‚æˆ‘å€‘ä¸Šé¢çœ‹åˆ°ä½¿ç”¨`eval(..)`çš„æƒ…æ³ï¼Œåœ¨æŸäº›æƒ…æ³ä¸‹JS engineå‰‡ç„¡æ³•åšå„ªåŒ–çš„å‹•ä½œï¼Œé€™æ™‚é–‰åŒ…ä¸­å°±æœƒæ“æœ‰æ‰€æœ‰çš„åŸå§‹è®Šæ•¸ã€‚æ›å¥è©±èªªï¼Œé–‰åŒ…å¿…é ˆæ ¹æ“šä¸åŒçš„ç¯„ç–‡é€²è¡Œæœ€ä½³åŒ–çš„å‹•ä½œï¼Œå®ƒæœƒç›¡é‡æ¸›å°‘è®Šæ•¸ä¿ç•™çš„æ•¸é‡ï¼Œé€™çµæœå°±å¦‚åŒæˆ‘å€‘ä¸€é–‹å§‹èªªæ˜é–‰åŒ…é‚£æ¨£ï¼Œæ²’ç”¨åˆ°çš„è®Šæ•¸éƒ½å°‡è¢«GCæ¸…é™¤æ‰ã€‚

ä½†åœ¨å¹¾å¹´å‰ï¼Œè¨±å¤šJS engineéƒ½æ²’æœ‰é€²è¡Œé€™ç¨®å„ªåŒ–ï¼Œè‹¥ä½ é‹è¡Œåœ¨è€èˆŠçš„è¨­å‚™æˆ–è€…æœªæ›´æ–°çš„ç€è¦½å™¨ä¸­ï¼Œæœªæ¸…é™¤çš„è®Šæ•¸å…¶è¨˜æ†¶é«”å ç”¨çš„æ™‚é–“æœƒæ¯”æˆ‘å€‘æƒ³åƒä¸­é‚„è¦ä¾†çš„é•·ã€‚ç”±æ–¼é€™å€‹å„ªåŒ–ä¸¦éåœ¨è¦ç¯„ç•¶ä¸­ï¼Œæ‰€ä»¥æˆ‘å€‘ä¸è©²ä¾è³´æ¯å°è¨­å‚™çš„JS engineéƒ½æœƒå¹«æˆ‘å€‘åšå„ªåŒ–çš„å‹•ä½œã€‚

è‹¥ä½ ä½¿ç”¨äº†ä¸€å€‹è¼ƒå¤§çš„é™£åˆ—æˆ–è€…ç‰©ä»¶ï¼Œç•¶ä½ ä¸å†ä½¿ç”¨å®ƒä¸¦ä¸”ä¸å¸Œæœ›ä¿ç•™å®ƒçš„è¨˜æ†¶é«”æ™‚ï¼Œé€²è¡Œæ‰‹å‹•ä¸Ÿæ£„çš„å‹•ä½œ(æœ‰é»åƒé¤Šæˆè‰¯å¥½è³‡æºå›æ”¶çš„æ¦‚å¿µ)ï¼Œè€Œä¸æ˜¯ä¾è³´é–‰åŒ…çš„å„ªåŒ–èˆ‡GCã€‚

è®“æˆ‘å€‘è©¦è‘—ä¿®æ”¹å‰é¢`manageStudentGrades(..)`çš„ä¾‹å­ï¼Œè®Šæ•¸`studentRecords`ç”±æ–¼æˆ‘å€‘ä¸å†ä½¿ç”¨å®ƒäº†ï¼Œæ‰€ä»¥å¯ä»¥é€éä¸‹é¢æ–¹å¼ä¾†é€²è¡Œæ‰‹å‹•æ¸…é™¤:

```javascript
function manageStudentGrades(studentRecords) {
    var grades = studentRecords.map(getGrade);

    // unset `studentRecords` to prevent unwanted
    // memory retention in the closure
    studentRecords = null;

    return addGrade;
    // ..
}
```

æˆ‘å€‘ä¸¦æ²’æœ‰çœŸæ­£çš„å¾é–‰åŒ…ä¸­æ¸…é™¤æ‰`studenRecords`ï¼Œå› ç‚ºé‚£ä¸¦ä¸åœ¨æˆ‘å€‘èƒ½æ§åˆ¶çš„ç¯„åœå…§ï¼Œæˆ‘å€‘åªèƒ½ç¢ºä¿å®ƒå°±ç®—è¢«éºç•™æ–¼é–‰åŒ…ç•¶ä¸­ï¼Œå®ƒè‡³å°‘ä¸æœƒå ç”¨å¤ªå¤šçš„è¨˜æ†¶é«”ï¼Œè‡³æ–¼æœ€å¾Œæ¸…é™¤é€™å€‹è®Šæ•¸çš„å·¥ä½œï¼Œå°±äº¤çµ¦GCè™•ç†å°±å¥½ã€‚é™¤äº†`studenRecords`ä»¥å¤–ï¼Œå¯¦éš›ä¸Š`getGrade`ä¹Ÿæ˜¯æˆ‘å€‘éœ€è¦æ¸…ç†çš„å°è±¡ã€‚

äº†è§£é–‰åŒ…åœ¨ç¨‹å¼ä¸­å‡ºç¾çš„ä½ç½®ä»¥åŠå®ƒåŒ…å«å“ªäº›è®Šæ•¸æ˜¯å¾ˆé‡è¦çš„ï¼Œä»”ç´°çš„ç®¡ç†é€™äº›é–‰åŒ…ï¼Œåƒ…ä¿ç•™æœ€åŸºæœ¬çš„éœ€æ±‚è€Œä¸æµªè²»å¤šé¤˜çš„è¨˜æ†¶é«”ï¼Œä¸è«–åœ¨å“ªç¨®ç¨‹å¼èªè¨€ä¸­éƒ½æ˜¯å¾ˆé‡è¦çš„ä¸€ç’°ã€‚

## å¦ä¸€ç¨®è§’åº¦çœ‹é–‰åŒ…

æˆ‘å€‘å…ˆä¾†çœ‹çœ‹å‰é¢çš„ä¾‹å­:

```javascript
// outer/global scope: RED(1)

function adder(num1) {
    // function scope: BLUE(2)

    return function addTo(num2){
        // function scope: GREEN(3)

        return num1 + num2;
    };
}

var add10To = adder(10);
var add42To = adder(42);

add10To(15);    // 25
add42To(9);     // 51
```

æˆ‘å€‘ç•¶å‰çš„è§€é»èªç‚ºï¼Œç„¡è«–åœ¨ä½•è™•å‚³éå’Œèª¿ç”¨å‡½å¼ï¼Œé–‰åŒ…éƒ½æœƒä¿ç•™ä¸€å€‹å›å»åŸå§‹ç¯„ç–‡çš„éš±è—è·¯å¾‘ï¼Œä»¥ä¾¿æ–¼è¨ªå•è¢«å°å­˜çš„è®Šæ•¸ã€‚æˆ‘å€‘é€éä¸‹åœ–ä¾†èªªæ˜æ­¤æ¦‚å¿µï¼š

![YDKJSY-10-1](/static/images/you-dont-know-js-yet-10-1.png)
<figcaption><em>Fig.1:Visualizing Closures(https://github.com/getify/You-Dont-Know-JS/blob/2nd-ed/scope-closures/images/fig4.png)</em></figcaption>

ä¸Šé¢ä¾‹å­ä¸­çš„å…§éƒ¨å‡½å¼`addTo(..)`é€éå‡½å¼`adder(..)`å›å‚³å®ƒçš„å¯¦ä¾‹çµ¦RED(1)ç¯„ç–‡ä¸­çš„è®Šæ•¸(`add10To`èˆ‡`add42To`)ï¼Œä½†æˆ‘å€‘å¯ä»¥ç”¨å¦å¤–ä¸€ç¨®æ€è€ƒæ–¹å¼ï¼Œæƒ³åƒå›å‚³çš„å‡½æ•¸å¯¦ä¾‹å¯¦éš›ä¸Šæ˜¯å›å‚³å®ƒæ‰€å±¬ä½ç½®çš„ç¯„ç–‡ï¼Œå…¶ä¸­ä¹ŸåŒ…å«æ•´å€‹ç¯„ç–‡éˆï¼Œä¹Ÿå°±æ˜¯èªªé€™å€‹è³¦å€¼çš„å‹•ä½œå¯¦éš›ä¸Šæ˜¯æŠŠæ•´å€‹ç¯„ç–‡éƒ½å‚³ééå»ï¼Œè€Œéåªæ˜¯ä¸€å€‹å‡½å¼ã€‚æˆ‘å€‘é€éä¸‹åœ–ä¾†çœ‹çœ‹é€™å€‹æ¦‚å¿µèˆ‡ä¸Šé¢çš„å·®ç•°:

![YDKJSY-10-2](/static/images/you-dont-know-js-yet-10-2.png)
<figcaption><em>Fig.2:Visualizing Closures (Alternative)(https://github.com/getify/You-Dont-Know-JS/blob/2nd-ed/scope-closures/images/fig5.png)</em></figcaption>

å¾ä¸Šåœ–å¯ä»¥çœ‹åˆ°å‡½å¼`adder(..)`æ¯æ¬¡éƒ½æœƒå‰µç«‹ä¸€å€‹æ–°çš„BLUE(2)ç¯„ç–‡ï¼Œå…¶ä¸­åŒ…å«äº†è®Šé‡`num1`ï¼Œä»¥åŠå‡½å¼`addTo(..)`çš„å¯¦ä¾‹èˆ‡å®ƒçš„ç¯„ç–‡GREEN(3)ã€‚èˆ‡*Fig.1*ä¸åŒçš„åœ°æ–¹åœ¨æ–¼`addTo(..)`å®ƒçš„ä½ç½®ç•™åœ¨BLUE(2)ä¹‹ä¸­ï¼Œç„¶å¾Œ`add10To`èˆ‡`add42To`ç§»åˆ°RED(1)ä¹‹ä¸­ï¼Œä¸”å®ƒå€‘ä¸å†åªæ˜¯è¡¨ç¤º`addTo(..)`çš„å¯¦ä¾‹ã€‚ç•¶`add10To`è¢«åŸ·è¡Œæ™‚ï¼Œå®ƒä¾èˆŠå­˜åœ¨æ–¼BLUE(2)ï¼Œæ‰€ä»¥å®ƒå¯ä»¥å¾ˆè‡ªç„¶çš„å­˜å–ç¯„ç–‡éˆçš„è®Šæ•¸ã€‚

æ‰€ä»¥ä¸Šé¢å…©å€‹æè¿°æ–¹å¼å“ªä¸€å€‹æ˜¯å°çš„å‘¢?å¯¦éš›ä¸Šå…©å€‹éƒ½æ˜¯å°çš„ï¼Œåªæ˜¯ç”¨ç¯„ç–‡éˆçš„è§€é»ä¾†çœ‹å¾…é–‰åŒ…ï¼Œæ›´è²¼è¿‘æˆ‘å€‘å¯¦éš›ä½¿ç”¨ç¨‹å¼æ™‚çš„ç‹€æ³ã€‚é–‰åŒ…æè¿°äº†ä¸€å€‹å‡½å¼çš„å¯¦ä¾‹ä¸åƒ…åƒ…åªæ˜¯ä¸€å€‹å‡½å¼è€Œå·²ï¼Œé‚„æœ‰å…¶èƒŒå¾Œé€£çµæ•´å€‹ç¯„ç–‡éˆçš„èƒ½åŠ›ã€‚ä¸è«–ä½ é¸æ“‡å“ªä¸€ç¨®æ–¹å¼ä¾†ç†è§£é–‰åŒ…ï¼Œæˆ‘å€‘é€éç¨‹å¼è§€å¯Ÿåˆ°çš„ç‹€æ³éƒ½æ˜¯ä¸€æ¨£çš„ã€‚

## é€éé–‰åŒ…æ”¹å–„ç¨‹å¼ç¢¼

å‰é¢æˆ‘å€‘å·²ç¶“äº†è§£é–‰åŒ…åˆ°åº•å¦‚ä½•é‹ä½œçš„äº†ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘ä¾†è¨è«–å¦‚ä½•ä½¿ç”¨é–‰åŒ…ä¾†æ”¹å–„ç¨‹å¼ç¢¼æ¶æ§‹ã€‚

å‡è¨­æˆ‘å€‘æœ‰ä¸€å€‹æŒ‰éˆ•ï¼ŒæŒ‰ä¸‹å»å°±æœƒé€éAjaxç™¼é€èˆ‡æ¥æ”¶ä¸€äº›è³‡æ–™ã€‚é¦–å…ˆæˆ‘å€‘å…ˆçœ‹çœ‹ä¸ä½¿ç”¨é–‰åŒ…çš„ä¾‹å­:

```javascript
var APIendpoints = {
    studentIDs:
        "https://some.api/register-students",
    // ..
};

var data = {
    studentIDs: [ 14, 73, 112, 6 ],
    // ..
};

function makeRequest(evt) {
    var btn = evt.target;
    var recordKind = btn.dataset.kind;
    ajax(
        APIendpoints[recordKind],
        data[recordKind]
    );
}

// <button data-kind="studentIDs">
//    Register Students
// </button>
btn.addEventListener("click",makeRequest);
```

å‡½å¼`makeRequest(..)`ç”¨æ–¼å¾é»æ“Šäº‹ä»¶æ¥æ”¶ä¸€å€‹`evt`ç‰©ä»¶ï¼Œé€™å‡½å¼æœƒå¾ç›®æ¨™æŒ‰éˆ•ä¸­ç²å–`data-kind`å±¬æ€§ï¼Œä¸¦ä½¿ç”¨ç²å–åˆ°çš„å€¼é€²è¡Œå°æ‡‰çš„Ajaxè«‹æ±‚ã€‚

ä¸Šé¢é€™æ®µç¨‹å¼ç¢¼å¯ä»¥æ­£å¸¸çš„é‹ä½œï¼Œä½†æœ‰ä¸€äº›å•é¡Œå­˜åœ¨ï¼Œå®ƒåœ¨æ¯æ¬¡äº‹ä»¶è§¸ç™¼æ™‚éƒ½æœƒå»ç²å–DOMå±¬æ€§ï¼Œé€™æœƒé€ æˆæ•ˆèƒ½çš„ä½è½ï¼Œç†ç•¶èªªæˆ‘å€‘åªè¦å†åŠ å…¥ç›£è½æ™‚ï¼Œå°‡å®ƒçš„DOMå±¬æ€§è¨˜ä¸‹å°±å¥½ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥é€éé–‰åŒ…ä¾†è§£æ±ºé€™å•é¡Œ:

```javascript
var APIendpoints = {
    studentIDs:
        "https://some.api/register-students",
    // ..
};

var data = {
    studentIDs: [ 14, 73, 112, 6 ],
    // ..
};

function setupButtonHandler(btn) {
    var recordKind = btn.dataset.kind;

    btn.addEventListener(
        "click",
        function makeRequest(){
            ajax(
                APIendpoints[recordKind],
                data[recordKind]
            );
        }
    );
}

// <button data-kind="studentIDs">
//    Register Students
// </button>

setupButtonHandler(btn);
```

é€™è£¡æ”¹ä½¿ç”¨å‡½å¼`setupButtonHandler(..)`ï¼Œåœ¨å…¶ä¸­æˆ‘å€‘åªé€²è¡Œä¸€æ¬¡æª¢ç´¢DOMå±¬æ€§çš„å‹•ä½œï¼Œæ¥è‘—å°±åŠ å…¥æŒ‰éˆ•çš„äº‹ä»¶ç›£è½ï¼Œå…¶ä¸­å‡½å¼`makeRequest()`æœƒå°é–å¤–éƒ¨è®Šæ•¸`recordKind`ï¼Œåœ¨æ¯æ¬¡è§¸ç™¼äº‹ä»¶æ™‚ï¼Œéƒ½æœƒä½¿ç”¨ç›¸åŒçš„å€¼ï¼Œè€Œä¸ç”¨åƒå‰é¢ä¸€æ¨£æ¯æ¬¡éƒ½æª¢ç´¢ä¸€æ¬¡ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘å€‘é‚„å¯ä»¥æ›¿æ›`ajax`ä¸­åƒæ•¸çš„éƒ¨åˆ†ï¼Œç”±æ–¼åœ¨æ¯æ¬¡è§¸ç™¼æ™‚éœ€è¦å¾å…¨åŸŸè®Šæ•¸`APIendpoints`èˆ‡`data`é€²è¡Œæª¢ç´¢çš„å‹•ä½œï¼Œæˆ‘å€‘å¯ä»¥é€éä»¥ä¸‹é€™ç¨®æ–¹å¼ä¾†æ”¹å¯«:

```javascript
function setupButtonHandler(btn) {
    var recordKind = btn.dataset.kind;
    var requestURL = APIendpoints[recordKind];
    var requestData = data[recordKind];

    btn.addEventListener(
        "click",
        function makeRequest(){
            ajax(requestURL,requestData);
        }
    );
}
```

å‡½å¼`makeRequest()`ä¹Ÿå°å­˜äº†è®Šæ•¸`requestURL`èˆ‡`requestDate`ï¼Œé€™æ¨£çœ‹èµ·ä¾†æ¯”è¼ƒå…·æœ‰å¯è®€æ€§ä¸”æ•ˆç‡ä¹Ÿæ¯”è¼ƒå¥½ã€‚

æˆ‘å€‘åˆ©ç”¨é–‰åŒ…çš„ç‰¹æ€§ï¼Œå°‡ä¸€äº›è¨Šæ¯(è®Šæ•¸)å°è£æ–¼å‡½å¼ä¹‹ä¸­ï¼Œé€™äº›å¸¶æœ‰è¨Šæ¯çš„å‡½å¼å°±ä¸éœ€è¦å¸¶å…¥åƒæ•¸è€Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œé€™å¯ä»¥ä½¿ç¨‹å¼ç¢¼è®Šå¾—è¼ƒç‚ºç°¡æ½”ä¸¦ä¸”é‚„æä¾›äº†ä½¿ç”¨æ›´å¥½çš„èªç¾©åç¨±ä¾†æ¨™è¨˜å‡½æ•¸çš„æ©Ÿæœƒã€‚

æˆ‘å€‘å¯ä»¥å†é€²ä¸€æ­¥æ”¹é€²ç¨‹å¼ç¢¼ï¼Œè®“ç¨‹å¼å¯é‡è¤‡ä½¿ç”¨:

```javascript
function defineHandler(requestURL,requestData) {
    return function makeRequest(){
        ajax(requestURL,requestData);
    };
}

function setupButtonHandler(btn) {
    var recordKind = btn.dataset.kind;
    var handler = defineHandler(
        APIendpoints[recordKind],
        data[recordKind]
    );
    btn.addEventListener("click",handler);
}
```

é€™æ®µç¨‹å¼ç¢¼èˆ‡å‰é¢ä»‹ç´¹çš„ç›¸ç•¶é¡ä¼¼ï¼Œåªæ˜¯æˆ‘å€‘è®“`makeRequest()`æå‰é€²è¡Œå°å­˜çš„å‹•ä½œä¸¦å°‡çµæœè³¦äºˆè®Šæ•¸`handler`ï¼Œ
å‡½å¼`defineHandler(..)`åœ¨ç¨‹å¼ä¸­å°‡èƒ½è¢«é‡è¤‡çš„ä½¿ç”¨ã€‚æˆ‘å€‘é‚„æ˜ç¢ºåœ°å°‡é–‰åŒ…é™åˆ¶ç‚ºåƒ…éœ€è¦å…©å€‹è®Šæ•¸(requestURLèˆ‡requestData)ã€‚

## ç¸½çµ

æˆ‘å€‘å¯ä»¥å°‡é–‰åŒ…è§£é‡‹æˆä¸‹é¢å…©ç¨®æ¨¡å¼:

- **ä»¥è§€å¯Ÿçš„è§’åº¦**:é–‰åŒ…æ˜¯ä¸€å€‹å‡½å¼çš„å¯¦ä¾‹ï¼Œå³ä½¿è©²å‡½å¼è¢«å‚³éåˆ°å…¶ä»–ç¯„ç–‡ï¼Œä¸¦åœ¨å…¶ä»–ç¯„ç–‡è¢«èª¿ç”¨ï¼Œå®ƒä¾èˆŠæœƒè¨˜ä½å¤–éƒ¨è®Šæ•¸ã€‚
- **ä»¥ç¯„ç–‡éˆçš„è§’åº¦**:é–‰åŒ…æ˜¯ä¸€å€‹å‡½å¼çš„å¯¦ä¾‹ï¼Œå®ƒçš„ç¯„ç–‡æœƒä¿ç•™æ–¼åŸæœ¬çš„ä½ç½®ï¼Œä»»ä½•åƒè€ƒéƒ½æœƒæŒ‡å‘é€™å€‹ä½ç½®ï¼Œä¹‹å¾Œçš„é‹ä½œå°±å¦‚åŒæ–¼ç¯„ç–‡éˆä¸€èˆ¬ã€‚

é–‰åŒ…èƒ½ç‚ºæˆ‘å€‘å¸¶ä¾†çš„å¥½è™•:

- é–‰åŒ…å¯ä»¥å°‡è¨Šæ¯é€²è¡Œå°å­˜ï¼Œè¨˜ä½å·²ç¶“ç¢ºèªéçš„è¨Šæ¯ï¼Œè€Œä¸å¿…æ¯æ¬¡éƒ½é€²è¡Œè¨ˆç®—æˆ–æŸ¥è©¢çš„å‹•ä½œï¼Œé€²è€Œæé«˜ç¨‹å¼åŸ·è¡Œçš„æ•ˆç‡ã€‚
- é–‰åŒ…é€šéå°‡è®Šæ•¸å°å­˜æ–¼å‡½å¼å¯¦ä¾‹ä¹‹ä¸­ä¾†å¢åŠ ç¨‹å¼çš„å¯è®€æ€§ï¼Œç¢ºä¿ç•¶å‡½å¼è¢«èª¿ç”¨æ™‚è¨Šæ¯æœ‰è¢«ä¿ç•™ä¸‹ä¾†ï¼Œæ¸›å°‘è®Šæ•¸çš„æ›å…‰åŒæ™‚ä¹Ÿèƒ½å¸¶ä¾†[POLE](/archives/2020-03-12-you-dont-know-js-yet-9#æœ€å°‘æ›å…‰åŸå‰‡)çš„å¥½è™•ã€‚

## Reference

- [You don't know JavaScript Yet](https://github.com/getify/You-Dont-Know-JS)
- [You don't know JavaScript Yet:#1 ä»€éº¼æ˜¯JavaScript](/archives/2020-01-01-you-dont-know-js-yet-1)
- [You don't know JavaScript Yet:#2 æ¦‚è§€JS](/archives/2020-01-04-you-dont-know-js-yet-2)
- [You don't know JavaScript Yet:#3 æ·±å…¥JSçš„æ ¸å¿ƒ](/archives/2020-01-07-you-dont-know-js-yet-3)
- [You don't know JavaScript Yet:#4 ç¯„ç–‡](/archives/2020-01-31-you-dont-know-js-yet-4)
- [You don't know JavaScript Yet:#5 èªªæ˜èªå½™ç¯„ç–‡](/archives/2020-02-23-you-dont-know-js-yet-5)
- [You don't know JavaScript Yet:#6 ç¯„ç–‡éˆ](/archives/2020-02-27-you-dont-know-js-yet-6)
- [You don't know JavaScript Yet:#7 å…¨åŸŸç¯„ç–‡](/archives/2020-03-03-you-dont-know-js-yet-7)
- [You don't know JavaScript Yet:#8 è®Šæ•¸ç¥ç§˜çš„ç”Ÿå‘½é€±æœŸ](/archives/2020-03-06-you-dont-know-js-yet-8)
- [You don't know JavaScript Yet:#9 é™åˆ¶ç¯„ç–‡æ›å…‰](/archives/2020-03-12-you-dont-know-js-yet-9)
